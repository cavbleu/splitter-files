### **Как программа находит и извлекает файлы из бинарных данных**

#### Требования к входным данным

1. Поддерживаются:
   - Бинарные файлы любого размера
   - Частично поврежденные данные
   - Файлы с вложенными структурами

2. Ограничения:
   - Минимальный размер извлекаемого файла: 2KB
   - Требуется наличие валидных сигнатур

Программа обеспечивает надежное извлечение файлов даже из поврежденных данных, с подробной статистикой и информацией о процессе обработки. Многопоточная архитектура позволяет эффективно работать с большими файлами, сохраняя высокую точность распознавания форматов.

Это позволяет эффективно восстанавливать **целые файлы**, но **не гарантирует** работоспособность поврежденных данных внутри них. Для сложных случаев (например, перезаписанные PDF) могут потребоваться специализированные инструменты

---

### Порядок востановления данных

Программа использует **сигнатуры (магические числа)** файлов и дополнительные проверки структуры, чтобы определить начало и конец файла. Вот как это работает:


#### Этап 1: Подготовка и инициализация
1. Чтение входного файла целиком в память
2. Создание рабочего каталога для выходных файлов
3. Инициализация пула worker-потоков (по умолчанию = количеству CPU ядер)

#### Этап 2: Поиск начала файла
Программа ищет **уникальные последовательности байтов** (магические числа), которые указывают на начало файла определенного формата путем последовательного чтения сигнатур в бинерном файле.

---
 **Примеры сигнатур:**
| Формат  | Сигнатура (HEX)                     | Описание                     |
|---------|------------------------------------|-----------------------------|
| **PDF** | `25 50 44 46` (`%PDF`)             | Первые 4 байта PDF-файла    |
| **ZIP** | `50 4B 03 04` (`PK..`)             | Сигнатура ZIP-архива        |
| **JPEG**| `FF D8 FF`                         | Начало JPEG-изображения     |
| **DOCX**| `50 4B 03 04` + проверка структуры | ZIP-контейнер + файлы Word  |
---
**Как это работает:**
1. Программа сканирует данные побайтово.
2. При обнаружении сигнатуры (например, `%PDF`) проверяется:
   - **Валидность** (например, для PDF проверяется версия `%PDF-1.7`).
   - **Структура файла** (например, наличие `xref` и `%%EOF` в PDF).

---

Пример проверки сигнатур:
```go
     var fileSignatures = []FileSignature{
         {Extension: "pdf", MagicNumber: []byte{0x25, 0x50, 0x44, 0x46}, Validator: validatePdf},
         // ... другие форматы
}
```

#### Этап 3: Валидация найденных файлов.
   - Для каждого потенциального файла вызывается соответствующая функция-валидатор
   - Проверка целостности структуры файла
   - Дополнительные проверки для специфических форматов:
     - Для PDF: проверка xref таблицы, маркеров начала/конца
     - Для Office: анализ структуры OOXML
     - Для JPEG: поиск маркеров начала/конца изображения

Не все файлы с правильной сигнатурой являются валидными. Поэтому программа дополнительно проверяет:
- **Для PDF**:
  ```go
  if !bytes.Contains(data, []byte("xref")) || !bytes.Contains(data, []byte("%%EOF")) {
      return false // Невалидный PDF
  }
  ```
- **Для JPEG**:
  ```go
  if !bytes.Contains(data, []byte{0xFF, 0xD9}) {
      return false // Неполное JPEG
  }
  ```
- **Для ZIP/DOCX**:
  ```go
  if !bytes.Contains(data, []byte{0x50, 0x4B, 0x05, 0x06}) {
      return false // Поврежденный ZIP
  }
  ```

#### Этап 4: Извлечение файлов
1. **Определение границ файла**:
   - Для каждого формата свой алгоритм:
     - PDF: поиск %%EOF + проверка xref
     - JPEG: поиск маркера FF D9
     - ZIP/Office: поиск сигнатуры PK\x03\x04 + центрального каталога

2. **Специальная обработка сложных случаев**:
   - Вложенные файлы (например, изображения в PDF)
   - Фрагментированные/поврежденные файлы
   - Перекрывающиеся файлы

3. **Сохранение извлеченных данных**:
   - Генерация уникальных имен файлов (file_0001.pdf, file_0002.jpg и т.д.)
   - Запись в выходной каталог
   - Сохранение метаинформации:
     - Позиция в исходном файле
     - Размер
     - Дополнительные атрибуты (для Office: версия, макросы, шифрование)

#### Этап 5:  Определение конца файла

После нахождения начала программа ищет **маркеры конца файла** или **следующую сигнатуру**.

**Способы определения конца:**
---
**A. Фиксированные маркеры конца**

Некоторые форматы имеют четкие маркеры окончания:
- **JPEG**: `FF D9` (конец изображения).
- **PDF**: `%%EOF` (но требуется дополнительная проверка структуры).
---
**B. Структурный анализ**

Для сложных форматов (PDF, DOCX) проверяется **корректность структуры**:
- **PDF**:
  - Должен содержать `xref` (таблица объектов).
  - Должен заканчиваться на `%%EOF` (но иногда встречаются "лишние" байты после).
  - Проверяется наличие `startxref` перед `%%EOF`.

- **ZIP/DOCX/XLSX**:
  - Ищется `50 4B 05 06` (сигнатура конца ZIP-архива).
  - Проверяется целостность внутренней структуры (например, наличие `[Content_Types].xml` в DOCX).

---

**C. Поиск следующей сигнатуры**
Если файл не имеет четкого маркера конца, программа:
1. Ищет **следующую сигнатуру** (например, после PDF может идти JPEG).
2. Если найдена новая сигнатура, конец предыдущего файла устанавливается **перед ней**.

---

#### Этап 6: Постобработка и отчетность
1. **Анализ покрытия**:
   - Построение карты обработанных данных
   - Выявление непокрытых участков
   - Обнаружение потенциально поврежденных областей

2. **Генерация отчетов**:
   - Статистика по извлеченным файлам
   - Предупреждения о проблемах
   - Визуализация структуры исходных данных


Пример вывода статистики:
```
=== Detailed Statistics ===
Input file size:       2,145,678 bytes
Extracted files:       23
Total extracted size:  2,010,432 bytes
Data coverage:         93.7%

File types distribution:
- PDF Document:        5
- Word Document:       3
- JPEG Image:          10
- ZIP Archive:         2
- Other:               3

Uncovered areas (3):
- 1,250,000 - 1,251,200 (1,200 bytes)
- 1,980,000 - 2,000,000 (20,000 bytes)
```

### Особенности обработки ключевых форматов

**PDF файлы**:
1. Поиск строго по началу файла (%PDF-)
2. Обязательная проверка:
   - Наличие xref таблицы
   - Корректный маркер конца (%%EOF)
   - Минимальный размер (1KB)
3. Игнорирование встроенных изображений
4. Корректная обработка переводов строк после %%EOF

**Офисные документы**:
1. Детектирование типа (Word/Excel/PowerPoint)
2. Анализ метаданных:
   - Версия документа
   - Наличие макросов (VBAProject)
   - Признаки шифрования
3. Проверка целостности OOXML структуры

**JPEG изображения**:
1. Точное определение границ по маркерам
2. Проверка валидности структуры
3. Корректная обработка progressive JPEG

### **Что происходит, если файл поврежден?**
- Если **конец файла не найден**, программа может:
  - Извлечь файл до следующей сигнатуры (возможно, неполный).
  - Пропустить файл, если он слишком мал (менее 2 КБ по умолчанию).

- Если **начало найдено, но структура нарушена**, файл помечается как **возможно поврежденный**.

---

### Пример работы на практике

**Допустим, у нас есть бинарный дамп:**
```
[Некоторые данные][%PDF-1.4 ... xref ... %%EOF][FF D8 FF ... FF D9][50 4B 03 04 ... 50 4B 05 06]
```
1. Программа находит `%PDF` → проверяет наличие `xref` и `%%EOF` → извлекает PDF.
2. Далее находит `FF D8 FF` → ищет `FF D9` → извлекает JPEG.
3. Затем находит `50 4B 03 04` → проверяет конец архива `50 4B 05 06` → извлекает ZIP.

---


### Ограничения программы (что она **не** может сделать):

---

#### 1. **Не поддерживает все форматы файлов**
   - Работает только с заранее заданными форматами:  
     `PDF, DOC/DOCX, XLS/XLSX, PPT/PPTX, JPEG, ZIP, RTF, ODT, HTML`.
   - **Не восстановит**:  
     - Видео (MP4, AVI и др.)  
     - Аудио (MP3, WAV)  
     - Специфичные форматы (CAD, базы данных, виртуальные диски и т.д.).

---

#### 2. **Не расшифровывает файлы**
   - Может определить, что файл зашифрован (например, запароленный PDF или Word),  
     но **не может**:
     - Подобрать пароль.
     - Расшифровать данные без ключа.

---

#### 3. **Не восстанавливает файловую систему**
   - Программа анализирует "сырые" бинарные данные, но:  
     - **Не** восстанавливает структуру папок.  
     - **Не** восстанавливает оригинальные имена файлов (все файлы получают имена вида `file_0001.pdf`).  
     - **Не** работает с удаленными файлами на дисках (для этого нужны специализированные утилиты вроде `PhotoRec`).

---

#### 4. **Не исправляет поврежденные данные внутри файлов**
   - Если файл частично перезаписан (например, половина JPEG отсутствует), программа:  
     - Извлечет его, но он может быть **нечитаемым**.  
     - **Не** "починит" внутреннюю структуру (например, битые таблицы в Excel).

---

#### 5. **Не гарантирует 100% восстановление**
   - Эффективность зависит от:  
     - Степени повреждения данных.  
     - Наличия фрагментов файлов в анализируемом дампе.  
   - Может пропускать файлы, если их сигнатуры повреждены.

---

#### 6. **Не работает с сетевыми/живыми системами**
   - Только анализ **статичных файлов** (например, дампов памяти или образов дисков).  
   - **Не** может:  
     - Сканировать жесткий диск напрямую.  
     - Восстанавливать файлы "на лету" с работающей системы.

---

#### 7. **Не поддерживает многотомные архивы**
   - Если ZIP-архив разбит на части (`part1.zip`, `part2.zip`), программа:  
     - Извлечет каждый том как отдельный файл,  
     - Но **не** объединит их автоматически.

---

### Когда программа **бесполезна**?
1. Файлы перезаписаны нулями/случайными данными (нет сигнатур).  
2. Данные зашифрованы **на уровне файловой системы** (BitLocker, VeraCrypt).  
3. Требуется восстановление метаданных (дата создания, права доступа).  

Для таких задач потребуются другие инструменты (например, `TestDisk` для ФС или `John the Ripper` для подбора паролей).

